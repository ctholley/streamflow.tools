---
title: "MARSS Model to Iterpolate Missing Streamflow Observations"
author: "Thomas Buehrens"
date: "2022-11-05"
output:
  html_document:
    code_folding: hide
    fig_caption: yes
    theme: cerulean
    toc: yes
    toc_depth: 3
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '3'
---


## Setup
All analyses require R software [**(link)**](https://cran.r-project.org/) (v3.4.3) for data retrieval, data processing, and summarizing model results. Here we configure R to perform our analysis and generate our outputs
```{r set_options, echo = TRUE, message = FALSE}
options(width = 100)
knitr::opts_chunk$set(message = FALSE)
set.seed(123)
```

We also need a couple of helper functions which we will load from the functions folder, which we will load using the walk() function from the purrr package (which we will install if it is not already installed).
```{r load_funcs, message = FALSE, warning = FALSE,results = "hide"}
wd_functions<-"../functions"
sapply(FUN = source, paste(wd_functions, list.files(wd_functions), sep="/"))
```

Here we will load & install packages we need to use (needs internet connection if packages not already installed)
```{r load_packages, message = FALSE, warning = FALSE,results = "hide"}
packages_list<-c("MARSS",
                 "tidyverse",
                 "lubridate", 
                 "kableExtra",
                 "dataRetrieval"
                 ) #BTSPAS loads separately
install_or_load_pack(packages_list)
```

## Flow Data
Get Naselle and Grays flow data
```{r message = FALSE, warning = FALSE,results = "hide"}
naselle<-get_USGS_data(flow_site =12010000, #Naselle
                        flow_params ="discharge",
                        daily_or_instantaneous= "daily",
                        begin_date = "2002-10-01",
                        end_date = "2022-09-30"
                        )

grays<-get_DOE_data(flow_site ="25B060", #Grays
                        flow_params ="discharge",
                        daily_or_instantaneous= "daily",
                        begin_date = "2002-10-01",
                        end_date = "2022-09-30"
                        )

elochoman<-get_DOE_data(flow_site ="25C060", #Elochoman
                        flow_params ="discharge",
                        daily_or_instantaneous= "daily",
                        begin_date = "2002-10-01",
                        end_date = "2022-09-30"
                        )

abernathy<-get_DOE_data(flow_site ="25E060", #Abernathy
                        flow_params ="discharge",
                        daily_or_instantaneous= "daily",
                        begin_date = "2002-10-01",
                        end_date = "2022-09-30"
                        )

chehalis_doty<-get_USGS_data(flow_site ="12020000", #Chehalis_doty
                        flow_params ="discharge",
                        daily_or_instantaneous= "daily",
                        begin_date = "2002-10-01",
                        end_date = "2022-09-30"
                        )


flow_dat<-naselle%>%
  dplyr::select(date,flow_cfs)%>%
  mutate(river="naselle")%>%
  bind_rows(grays%>%
              dplyr::select(date,flow_cfs)%>%
              mutate(river="grays")
              )%>%
  bind_rows(elochoman%>%
              dplyr::select(date,flow_cfs)%>%
              mutate(river="elochoman")
              )%>%
  bind_rows(abernathy%>%
              dplyr::select(date,flow_cfs)%>%
              mutate(river="abernathy")
              )%>%
  bind_rows(chehalis_doty%>%
              dplyr::select(date,flow_cfs)%>%
              mutate(river="chehalis_doty")
              )%>%
  group_by(river,date)%>%
  summarise(flow_cfs=mean(flow_cfs),.groups = "keep")%>%
  ungroup()%>%
  group_by(river)%>%
  mutate(zl_flow_cfs=as.vector(scale(log(flow_cfs))))%>%
  ungroup()#%>%
  # mutate(flow_cfs=ifelse(river=="grays" & zl_flow_cfs <= -2,NA,flow_cfs),
  #        )%>%
  # filter(!is.na(flow_cfs))%>%
  # group_by(river)%>%
  # mutate(zl_flow_cfs=as.vector(scale(log(flow_cfs))))
  
  flow_dat%>%group_by(river)%>%summarize(min_zl_flow=min(zl_flow_cfs),
                                         min_flow=min(flow_cfs)
                                         )
  
```

## Plot Flow Data
```{r message = FALSE, warning = FALSE,results = "show", fig.show=TRUE,fig.cap="Figure 1. Observed z-scored logged flow by river."}
ggplot(flow_dat,aes(x=date,y = zl_flow_cfs,color=river),alpha=0.5)+
  geom_point(size=0.3)
```

## MARSS Model 
```{r  message = FALSE, warning = FALSE,results = "hide"}
marss_dat<-flow_dat%>%
  dplyr::select(river,date,zl_flow_cfs)%>%
  pivot_wider(names_from = river,values_from = zl_flow_cfs,id_cols=date)%>%
  arrange(date)%>%
  mutate(jdate=julian(date))%>%
  filter(year(date)>2020)

all_dates<-tibble(jdate=julian(min(marss_dat$date)):julian(max(marss_dat$date)))

marss_dat<-all_dates%>%
  left_join(marss_dat)

marss_mat<-marss_dat%>%
  dplyr::select(-c(date,jdate))%>%
  as.matrix()%>%
  t()


model=list(
 Q= "equalvarcov",#"unconstrained"
 R= "diagonal and equal",
 U= matrix(rep(0,5),5,1)
)
fit=MARSS(marss_mat, model=model)

fitted<-t(fit$states)
colnames(fitted)<-gsub("X.","mle_",colnames(fitted))

marss_dat<-marss_dat%>%
  dplyr::select(-jdate)%>%
  bind_cols(fitted)%>%
  pivot_longer(cols=c(everything(),-date),names_to = "river")%>%
  mutate(type=ifelse(grepl("mle_",river),"mle","obs"))%>%
  mutate(river=gsub("mle_","",river))%>%
  pivot_wider(values_from =value,names_from = type)%>%
  arrange(river,date)
#write.csv(marss_dat,"marss_dat.csv")
```

## Plot Flow Data with MARSS Predictions
```{r  message = FALSE, warning = FALSE,results = "show", fig.show=TRUE,fig.cap="Figure 2: Comparison of Observed z-scored logged flow vs. MARSS fits"}
ggplot(marss_dat,aes(x=date,y=mle,group=river))+
  geom_line(color="cadetblue")+
  geom_point(aes(y=obs),size=0.1)+
  facet_wrap(~river)
```
